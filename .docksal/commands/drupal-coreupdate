#!/usr/bin/env bash

## Updates Drupal Core when in TravisCI cron or from local.
## Usage: fin drupal-coreupdate [try|sendpr] [--local]
## Parameters:
## try|sendpr  Either try doing core update(default) or send PR
## --local     Run from local environment.

coreupdate_try() {
  if [[ $(fin composer outdated "drupal/*"|grep -ic "^drupal/core") -eq 1 ]]; then
     fin composer update drupal/core --with-dependencies && \
     fin drush updb -y                                   && \
     fin drush cr -y                                     && \
     fin drush st
  else
     echo "No drupal core update detected."
  fi
}

coreupdate_pr() {
  apt-get install pip3
  pip3 install git-pull-request

  ## TODO: Create PR here against 'develop' core update done.
  echo "dummy: coreupdate send PR here"
  echo '-------- INSPECTING WORKING COPY -------'
  pwd
  git status
  git diff
  git remote -v
  which git-pull-request
  echo '-------- // INSPECTING WORKING COPY -------'
}

if [[ "$TRAVIS_EVENT_TYPE" = "cron" ]] || [[ "$2" = "--local" ]]; then
  case $1 in
    try)
      coreupdate_try
    ;;
    sendpr)
      coreupdate_pr
    ;;
    *)
      coreupdate_try
    ;;
  esac
else
  echo "Drupal core update skipped. See 'fin help drupal-coreupdate'."
fi
