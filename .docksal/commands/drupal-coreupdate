#!/usr/bin/env bash

## Updates Drupal Core when in TravisCI cron or from local.
## Usage: fin drupal-coreupdate [try|sendpr] [--local]
## Parameters:
## try|sendpr  Either try doing core update(default) or send PR
## --local     Run from local environment.

coreupdate_try() {
  if [[ $(fin composer outdated "drupal/*"|grep -ic "^drupal/core") -eq 1 ]]; then
     fin composer update drupal/core --with-dependencies && \
     fin drush updb -y                                   && \
     fin drush cr -y                                     && \
     fin drush st
  else
     echo "No drupal core update detected."
  fi
}

prep_drupalcoreupdate_branch() {
echo '------ START: prep_drupalcoreupdate_branch() -----------'
set -xv
  dcore_ver=$(fin drush st|grep "Drupal version"|cut -d':' -f2|sed 's/\ //g'|sed 's/\r//g')
  DRUPALCORE_BRANCH=drupalcore_${dcore_ver}
  cd ../
  git clone https://${GH_TOKEN}@github.com/promet/provus.git $DRUPALCORE_BRANCH
  cd $DRUPALCORE_BRANCH
  git fetch
  git checkout -b $DRUPALCORE_BRANCH
  cp ../provus/composer.lock .
  git add composer.lock
  git commit -m"PTECH-1569: Drupal update to ${dcore_ver}"
  git push -u origin $DRUPALCORE_BRANCH
set +xv
echo '------ // END: prep_drupalcoreupdate_branch() -----------'
}

coreupdate_pr() {
  ## Prep PR source branch
  ## TODO: Add checker to skip this if already pushed prior
  prep_drupalcoreupdate_branch

  ## TODO: Create PR here against 'develop' core update done.
  echo "dummy: coreupdate send PR here"
  echo '-------- INSPECTING WORKING COPY -------'
  pwd
  git status
  git diff
  git remote -v
  which git-pull-request
  echo '-------- // INSPECTING WORKING COPY -------'
}

if [[ "$TRAVIS_EVENT_TYPE" = "cron" ]] || [[ "$2" = "--local" ]]; then
  case $1 in
    try)
      coreupdate_try
    ;;
    sendpr)
      coreupdate_pr
    ;;
    *)
      coreupdate_try
    ;;
  esac
else
  echo "Drupal core update skipped. See 'fin help drupal-coreupdate'."
fi
